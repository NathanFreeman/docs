# Процессы/треды: блокировки Lock

* В `PHP` можно легко создать блокировку `Swoole\Lock`, чтобы обеспечить синхронизацию данных. Класс `Lock` поддерживает `5` типов блокировок.
* Для многопроцессного режима используется `Swoole\Thread\Lock`, который отличается только пространством имен и полностью соответствует интерфейсу `Swoole\Lock`.


Тип блокировки | Описание
---|---
SWOOLE_MUTEX | Мьютекс
SWOOLE_RWLOCK | Читательно-писательно блокировка
SWOOLE_SPINLOCK | Спин-блокировка
SWOOLE_FILELOCK | Файловая блокировка (отказана)
SWOOLE_SEM | Сигнал (отказан)

!> Не создавайте блокировки в таких обратных вызовах, как `/server/events?id=onreceive`, иначе память будет постоянно расти, что приведет к утечке памяти.


## Примеры использования

```php
$lock = new Swoole\Lock(SWOOLE_MUTEX);
echo "[Master]create lock\n";
$lock->lock();
if (pcntl_fork() > 0)
{
  sleep(1);
  $lock->unlock();
} 
else
{
  echo "[Child] Wait Lock\n";
  $lock->lock();
  echo "[Child] Get Lock\n";
  $lock->unlock();
  exit("[Child] exit\n");
}
echo "[Master]release lock\n";
unset($lock);
sleep(1);
echo "[Master]exit\n";
```


## Напоминания

!> блокировки не могут использоваться в координационных процессах, пожалуйста, используйте их осторожно и не выполняйте API, которые могут вызвать переключение координационных процессов, между `lock` и `unlock`.


### Плохой пример

!> Этот код `100%` прив会导致 в координационном режиме.

```php
$lock = new Swoole\Lock();
$c = 2;

while ($c--) {
  go(function () use ($lock) {
      $lock->lock();
      Co::sleep(1);
      $lock->unlock();
  });
}
```


## Методы


### __construct()

Конструктор.

```php
Swoole\Lock::__construct(int $type = SWOOLE_MUTEX, string $lockfile = '');
```

!> Не создавайте и не уничтожайте объекты блокировки в цикле, иначе произойдет утечка памяти.

  * **Параметры** 

    * **`int $type`**
      * **Функция**: Тип блокировки
      * **По умолчанию**: `SWOOLE_MUTEX`【Мьютекс】
      * **Другие значения**: нет

    * **`string $lockfile`**
      * **Функция**: Указывает путь к файлу блокировки【необходимо передать при типе `SWOOLE_FILELOCK`】
      * **По умолчанию**: нет
      * **Другие значения**: нет

!> Каждый тип блокировки поддерживает разные методы. Например, читательно-писательно блокировка и файловая блокировка могут поддерживать `$lock->lock_read()`. Кроме того, за исключением файловой блокировки, другие виды блокировок должны быть созданы в родительском процессе, чтобы дети, порожденные с помощью `fork`, могли конкурировать за блокировку.


### lock()

Операцию блокировки. Если другой процесс держит блокировку, то здесь будет блокировка до тех пор, пока процесс, держащий блокировку, не отпустит ее с помощью `unlock()`.

```php
Swoole\Lock->lock(): bool
```


### trylock()

Операцию блокировки. В отличие от метода `lock()`, `trylock()` не блокирует и сразу же возвращает результат.

```php
Swoole\Lock->trylock(): bool
```

  * **Возвращаемое значение**

    * Если блокировка успешно установлена, возвращается `true`, в это время можно изменять общие переменные
    * Если блокировка не установлена, возвращается `false`, что означает, что другой процесс держит блокировку

!> У `SWOOlE_SEM` сигнала нет метода `trylock`


### unlock()

Отпустить блокировку.

```php
Swoole\Lock->unlock(): bool
```


### lock_read()

Блокировка только для чтения.

```php
Swoole\Lock->lock_read(): bool
```

* В процессе удержания чтения другие процессы все еще могут получить чтение блокировки и продолжать чтение;
* Но нельзя `$lock->lock()` или `$lock->trylock()`, эти два метода обеспечивают эксклюзивное блокирование, и во время установления эксклюзивной блокировки другие процессы не могут выполнять никаких других операций блокировки, включая чтение блокировки;
* Когда другой процесс получает эксклюзивное блокирование (вызов `$lock->lock()`/`$lock->trylock()`), `$lock->lock_read()` будет заблокирован до тех пор, пока процесс, держащий эксклюзивное блокирование, не отпустит блокировку.

!> Только блокировки типов `SWOOLE_RWLOCK` и `SWOOLE_FILELOCK` поддерживают чтение блокировки только для чтения


### trylock_read()

Блокировка. Этот метод такой же, как и `lock_read()`, но не блокирующий.

```php
Swoole\Lock->trylock_read(): bool
```

!> Call will immediately return, you must check the return value to determine if the lock was acquired.

### lockwait()

Операцию блокировки. Функция такая же, как у метода `lock()`, но `lockwait()` позволяет устанавливать время ожидания.

```php
Swoole\Lock->lockwait(float $timeout = 1.0): bool
```

  * **Параметры** 

    * **`float $timeout`**
      * **Функция**: Указывает время ожидания
      * **Единица измерения**: секунды【Поддерживается плавающая точка, например, `1.5` означает `1s`+`500ms`】
      * **По умолчанию**: `1`
      * **Другие значения**: нет

  * **Возвращаемое значение**

    * Если в течение указанного времени блокировка не установлена, возвращается `false`
    * Если блокировка установлена успешно, возвращается `true`

!> Только блокировки типа `Mutex` поддерживают `lockwait`
