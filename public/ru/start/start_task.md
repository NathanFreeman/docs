# Выполнение асинхронных задач (Task)

В программе Server, если необходимо выполнить операции, которые занимают много времени, например, отправка broadcasts в чате-сервере или отправка писем в веб-сервере, прямое выполнение этих функций заблокирует текущий процесс, что приводит к замедлению ответа сервера.

Swoole предоставляет функции обработки асинхронных задач, которые позволяют отправить асинхронную задачу в пул рабочих процессов TaskWorker для выполнения, не влияя на скорость обработки текущих запросов.

## getSource code

На основе первого TCP-сервера необходимо добавить только две события обратной связи: [onTask](/server/events?id=ontask) и [onFinish](/server/events?id=onfinish). Кроме того, необходимо настроить количество рабочих процессов task, которые можно настроить в зависимости от времени выполнения задач и объема задач.

Пожалуйста, напишите следующий код в task.php.

```php
$serv = new Swoole\Server('127.0.0.1', 9501);

// Установите количество рабочих процессов для асинхронных задач.
$serv->set([
    'task_worker_num' => 4
]);

// Эта обратная связь выполняется в рабочем процессе.
$serv->on('Receive', function($serv, $fd, $reactor_id, $data) {
    // Отправьте асинхронную задачу
    $task_id = $serv->task($data);
    echo "Отправлена асинхронная задача: id={$task_id}\n";
});

// Обработка асинхронной задачи (эта обратная связь выполняется в рабочем процессе Task).
$serv->on('Task', function ($serv, $task_id, $reactor_id, $data) {
    echo "Новая асинхронная задача[id={$task_id}]".PHP_EOL;
    // Возвращает результат выполнения задачи
    $serv->finish("{$data} -> OK");
});

// Обработка результата асинхронной задачи (эта обратная связь выполняется в рабочем процессе).
$serv->on('Finish', function ($serv, $task_id, $data) {
    echo "Асинхронная задача[{$task_id}] завершена: {$data}".PHP_EOL;
});

$serv->start();
```

После вызова `$serv->task()`, программа сразу же возвращается и продолжает выполнять код ниже. Обработка onTask обратной связи выполняется асинхронно в пулах рабочих процессов Task. После завершения выполнения используется `$serv->finish()` для возврата результата.

!> Операция finish является необязательной, можно также не возвращать никаких результатов. Если в события onTask вернуть результат с помощью `return`, это эквивалентно использованию операции `$Swoole\Server::finish()`.
