# Методы и свойства


## Методы


### `__construct()`
Метод конструктора для многопутевого выполнения

```php
Swoole\Thread->__construct(string $script_file, mixed ...$args)
```
* **Параметры**
    * `string $script_file`
        * Функция: Файл, который будет исполняться после запуска нити.
        * По умолчанию: нет.
        * Другие значения: нет.

    * `mixed $args`
        * Функция: Shared данные, передаваемые главной нити в дочернюю нить, которые можно получить с помощью метода `Swoole\Thread::getArguments()` в дочерней нити.
        * По умолчанию: нет.
        * Другие значения: нет.

!> Если создание нити потерпит неудачу, будет выброшена исключение `Swoole\Exception`, которое можно поймать с помощью `try-catch`.


### `join()`
Главная нить ждет, пока дочерняя нить не закончит работу. Если дочерняя нить все еще работает, `join()` будет блокировать до тех пор, пока дочерняя нить не закончит работу.

```php
Swoole\Thread->join(): bool
```
* **Возвращаемое значение**
    * Возвращает `true`, если операция прошла успешно, и `false`, если операция потерпела неудачу.


### `joinable()`
Проверяет, вышла ли дочерняя нить из работы.

```php
Swoole\Thread->joinable(): bool
```


#### Возвращаемое значение

- `true`, если дочерняя нить уже вышла, и в этот момент вызов `join()` не приведет к блокировке
- `false`, если дочерняя нить еще не вышла


### `detach()`
Отделяет дочернюю нить от контроля главной нити, после чего `join()` больше не будет блокировать до тех пор, пока нить не закончит работу.

```php
Swoole\Thread->detach(): bool
```
* **Возвращаемое значение**
    * Возвращает `true`, если операция прошла успешно, и `false`, если операция потерпела неудачу.


### `getId()`
Статический метод, возвращающий ID текущей нити.

```php
Swoole\Thread::getId(): int
```
* **Возвращаемое значение**
    * Возвращает целое число, представляющее ID текущей нити.


### `getArguments()`
Статический метод, возвращающий shared данные, переданные главной нить при создании новой нити с помощью `new Swoole\Thread()`, которые можно использовать в дочерней нити.

```php
Swoole\Thread::getArguments(): ?array
```

* **Возвращаемое значение**
    * В дочерней нити возвращает shared данные, переданные родительским процессом.

?> В главной нити нет никаких параметров нити, их можно определить, проверяя пустоту параметров нити, чтобы выполнить разную логику для родительской и дочерней нитей
```php
use Swoole\Thread;

$args = Thread::getArguments(); // Если это основная нить, $args пуст, если это дочерняя нить, $args не пуст
if (empty($args)) {
    # Основной нить
    new Thread(__FILE__, 'child thread'); // Передача параметров нити
    echo "main thread\n";
} else {
    # Дочерняя нить
    var_dump($args); // Вывод: ['child thread']
}
```


### `getInfo()`
Статический метод, возвращающий информацию о текущей многопутевой среде.

```php
Swoole\Thread::getInfo(): array
```
Возвращаемая информация в виде массива:



- `is_main_thread` : текущая нить является ли главной нитью

- `is_shutdown` : нить уже закрыта

- `thread_num` : количество активных нитей


### `getPriority()`
Статический метод, возвращающий информацию о текущей нить调度е

```php
Swoole\Thread->getPriority(): array
```
Возвращаемая информация в виде массива:



- `policy` : стратегия调度 нити

- `priority` : приоритет调度 нити


### `setPriority()`
Статический метод, устанавливающий приоритет и стратегию调度 текущей нити

?> Только пользователь `root` может настроить это, попытки настройки другими пользователями будут отклонены

```php
Swoole\Thread->setPriority(int $priority, int $policy = -1): bool
```

* **Параметры**
    * `int $priority`
        * Функция: Установить приоритет调度 нити
        * По умолчанию: нет.
        * Другие значения: нет.

    * `mixed $policy`
        * Функция: Установить стратегию调度 нити
        * По умолчанию: `-1`, что означает не изменять стратегию调度.
        * Другие значения: константы `Thread::SCHED_*`.

* **Возвращаемое значение**
    * Успешное выполнение возвращает `true`
    * Неудача возвращает `false`, для получения информации об ошибке используйте `swoole_last_error()`

> `SCHED_BATCH/SCHED_ISO/SCHED_IDLE/SCHED_DEADLINE` доступны только на `Linux` системах  

> Нити с стратегиями调度 `SCHED_FIFO/SCHED_RR` обычно являются реального времени нитями, имеют более высокий приоритет, чем обычные нити и получают больше времени на CPU


### `getAffinity()`
Статический метод, возвращающий CPU-affinitет текущей нити

```php
Swoole\Thread->getAffinity(): array
```
Возвращаемое значение - это массив, элементы которого являются числами ядер CPU, например: `[0, 1, 3, 4]`, что означает, что эта нить будет распределена для выполнения на ядрах CPU `0/1/3/4`


### `setAffinity()`
Статический метод, устанавливающий CPU-affinitет текущей нити

```php
Swoole\Thread->setAffinity(array $cpu_set): bool
```

* **Параметры**
    * `array $cpu_set`
        * Функция: список ядер CPU, например `[0, 1, 3, 4]`
        * По умолчанию: нет.
        * Другие значения: нет.

* **Возвращаемое значение**
    * Успешное выполнение возвращает `true`
    * Неудача возвращает `false`, для получения информации об ошибке используйте `swoole_last_error()`


### `setName()`
Статический метод, устанавливающий имя текущей нити. Это предоставляет более дружественное отображение при использовании инструментов, таких как `ps` и `gdb`, для просмотра и отладки.

```php
Swoole\Thread->setName(string $name): bool
```

* **Параметры**
    * `string $name`
        * Функция: имя нити
        * По умолчанию: нет.
        * Другие значения: нет.

* **Возвращаемое значение**
    * Успешное выполнение возвращает `true`
    * Неудача возвращает `false`, для получения информации об ошибке используйте `swoole_last_error()`

```shell
$ ps aux | grep -v grep | grep pool.php
swoole   2226813  0.1  0.1 423860 49024 pts/6    Sl+  17:38   0:00 php pool.php

$ ps -T -p 2226813
    PID    SPID TTY          TIME CMD
2226813 2226813 pts/6     00:00:00 Master Thread
2226813 2226814 pts/6     00:00:00 Worker Thread 0
2226813 2226815 pts/6     00:00:00 Worker Thread 1
2226813 2226816 pts/6     00:00:00 Worker Thread 2
2226813 2226817 pts/6     00:00:00 Worker Thread 3
```


### `getNativeId()`
Получение системного `ID` нити, который будет возвращен как целое число, аналогично `PID` процесса.

```php
Swoole\Thread->getNativeId(): int
```

Эта функция на `Linux` системах будет вызвать системный вызов `gettid()`, чтобы получить `ID`类似于 операционной системы для нити, который является коротким целым числом. Когда нить процесса уничтожается, она может быть забрана операционной системой.

Этот `ID` может использоваться для отладки с помощью `gdb`, `strace` и т.д., например, `gdb -p $tid`. Кроме того, можно прочитать информацию о выполнении нити из `/proc/{PID}/task/{ThreadNativeId}`.


## Свойства


### `id`
Получение `ID` дочерней нити через это свойство объекта, которое является типом `int`.

> Это свойство может использоваться только в родительской нити, в дочерней нити невозможно получить объект `$thread`, вместо этого следует использовать статический метод `Thread::getId()` для получения `ID` нити

```php
$thread = new Swoole\Thread(__FILE__, $i);
var_dump($thread->id);
```


## Константы

Название | Функция
---|---
`Thread::HARDWARE_CONCURRENCY` | Количество физических нитей, обычно равно числу ядер CPU
`Thread::API_NAME` | Название API нити, например `POSIX Threads`
`Thread::SCHED_OTHER` | Стратегия调度 нити `SCHED_OTHER`
`Thread::SCHED_FIFO` | Стратегия调度 нити `SCHED_FIFO`
`Thread::SCHED_RR` | Стратегия调度 нити `SCHED_RR`
`Thread::SCHED_BATCH` | Стратегия调度 нити `SCHED_BATCH`
`Thread::SCHED_ISO` | Стратегия调度 нити `SCHED_ISO`
`Thread::SCHED_IDLE` | Стратегия调度 нити `SCHED_IDLE`
`Thread::SCHED_DEADLINE` | Стратегия调度 нити `SCHED_DEADLINE`
