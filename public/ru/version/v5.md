# v5.0


Основные обновления
-------
1. Добавлена поддержка отдельного запуска `swoole-cli`
2. Минимальная версия PHP调整为8.0
3. Сильный тип, все параметры и возвращаемые значения функций и методов классов являются строго типов
4. Усилена управление основными сервисами
5. удалено некоторые исторические функции


Новая режим работы (swoole-cli)
-------
В `5.0` будет добавлена поддержка `swoole-cli`, `swoole` будет предоставляться пользователям как отдельная программа, подобно `node.js`, а не как расширение PHP.
Кроме того, `swoole-cli` максимально уменьшит `php-src`, удалив некоторые неиспользуемые механизмы, модули, расширения, функции, типов, константы, код, чтобы весь программный комплекс мог быть скомпилирован в течение нескольких минут.

```shell
htf@htf-ThinkPad-T470p:~/workspace$ ./swoole-cli -v
Swoole 5.0.0 (cli) (Built:Nov 26 2021 07:22:46)
```


### Статическое собирание без зависимостей
`swoole-cli` будет использовать только статическое связывание, `libc` и `libstdc++` будут использовать `musl`, и будут включены библиотеки и расширения `openssl` и `curl`. Пользователи могут изменитьscript сборки, чтобы добавить другие сторонние расширения.
Это делает программы `swoole` независимыми от каких-либо системных so и позволяет их копировать и распространять между любыми `Linux` системами для выполнения.

```shell
htf@htf-ThinkPad-T470p:~/workspace$ ldd swoole-cli
Не динамический Executable
htf@htf-ThinkPad-T470p:~/workspace$
```


### Удаление механизма загрузки динамических расширений
Удален функция `dl()` и механизм загрузки динамических расширений через `php.ini` `extension={name}.so`, все расширения должны быть statically编译ены.
`swoole-cli` позволяет создавать индивидуальные системы сборки, добавляя расширения в список модулей

### Удаление встроенного сервера `php -S`
В контексте `swoole` это бессмысленно


### Удаление встроенных расширений
Удалены встроенные расширения с низким использованием, историческими и несовместимыми с корутинами, включая, но не ограничиваясь:
```
com_dotnet
dba
ftp
ffi
imap
ldap
oci8
odbc
pdo_dblib
pdo_firebird
pdo_oci
pdo_odbc
pdo_pgsql
pgsql
pspell
shmop
snmp
sysvmsg
sysvsem
tidy
```


### Удаление некоторых функций
Удалены встроенные функции, которые не являются `cli`, имеют низкое использование, исторические и несовместимые с корутинами, включая, но не ограничиваясь:
```
checkdnsrr
dns_check_record
dns_get_mx
header
header_register_callback
header_remove
session_start
mail
```

### Удаление ZTS
Удален режим `ZTS`, так как в `cli` режиме `ZTS` не имеет никакого смысла.


Чтобы отправить большие файлы, в HTTP-сервере появилась поддержка для отправки больших файлов. Configurable maximum file size limit is set via the `upload_max_filesize` configuration option.
Different from `package_max_length`, this feature writes the file content directly to a temporary file in the `multipart/form-data`, which的好处是不会占用太多内存即可完成超大文件的上传。
`package_max_length` can be set to 2M, and `upload_max_filesize` can be set to 2G, and each connection only needs 2M of memory to complete the upload of a 2G big file.

```php
$server->set([
    'upload_max_filesize' => 2 * 1024 * 1024 * 1024, // 2G
    'package_max_length' => 2 * 1024 * 1024, // 2M
]);
```


Подробный список
-------



### Добавлено

- Добавлена конфигурационная опция `Server`: `max_concurrency`, которая может ограничить максимальное количество одновременных запросов для HTTP1/2 услуг, после чего будет возвращаться ошибка 503

- Добавлена конфигурационная опция `Coroutine\Http\Client`: `max_retries`, которая автоматически меняет узел для повторной попытки в случае неудачи соединения, HTTP 502/503

- Добавлена глобальная конфигурационная опция `name_resolver`, которая усиливает функциюDNS-разрешения. В версиях до 5.0 домены могли быть решаны только с помощью DNS, начиная с 5.0, можно настроить `name_resolver` использовать такие сервисы для обнаружения, как Consul или Nacos

- Добавлена функция `Coroutine::getExecuteTime()`, которая позволяет получить фактическое время выполнения корутины (включая время, в котором корутина находится в состоянии `yield`)
- Добавлена конфигурация `upload_max_filesize`, позволяющая отправлять большие файлы.




### Улучшено

- Сильный тип, все параметры и возвращаемые значения функций и методов классов теперь имеют точные типовые ограничения
- Все конструкторы, которые ранее приводили к неудаче, теперь выбрасывают исключения




### Удалено

- Удалены классы в стиле PSR-0, например, `swoole_http_server` должен быть изменен на `Swoole\Http\Server`
- Удалено автоматическое добавление вызова `Event::wait()` в функцию `shutdown`, теперь необходимо явно вызвать `Event::wait()` для входа в состояние ожидания событий, или использовать контейнеры такие как `Co\run()`, `Server::start()`, `Process::start()`, `Process\Pool::start()` и т.д.
- Удалены псевдонимы `Server::tick/after/clearTimer/defer`, теперь следует использовать `Timer::tick()/Timer::after()/Timer::clear()/Event::defer()`
