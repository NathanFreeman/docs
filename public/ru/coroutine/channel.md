# Корутины\Канал

> Рекомендуем сначала посмотреть [Обзор](/coroutine), чтобы понять основные концепции корутин, прежде чем обратиться к этой главе.

Канал используется для коммуникации между корутинами, поддерживает многопоставщиков и многокonsумеров корутин. В основе автоматически реализуется переключение и диспетчеризация корутин.

## Принцип реализации

  * Канал похож на `PHP` `Array`, занимает только память, без других дополнительных ресурсов, все операции являются памятьными, без `IO` потребления
  * В основе используется `PHP` счетчик ссылок для реализации, без копирования памяти. Даже передача огромных строк или массивов не приведет к дополнительному производственному расходу
  * `channel` реализован на основе счетчика ссылок, это ноль копий

## Примеры использования

```php
use Swoole\Coroutine;
use Swoole\Coroutine\Channel;
use function Swoole\Coroutine\run;

run(function(){
    $channel = new Channel(1);
    Coroutine::create(function () use ($channel) {
        for($i = 0; $i < 10; $i++) {
            Coroutine::sleep(1.0);
            $channel->push(['rand' => rand(1000, 9999), 'index' => $i]);
            echo "{$i}\n";
        }
    });
    Coroutine::create(function () use ($channel) {
        while(1) {
            $data = $channel->pop(2.0);
            if ($data) {
                var_dump($data);
            } else {
                assert($channel->errCode === SWOOLE_CHANNEL_TIMEOUT);
                break;
            }
        }
    });
});
```

## Методы


### __construct()

Конструктор канала.

```php
Swoole\Coroutine\Channel::__construct(int $capacity = 1)
```

  * **Параметры** 

    * **`int $capacity`**
      * **Функция**：Установить емкость 【должно быть целым числом, больше или равным `1`】
      * **По умолчанию**：`1`
      * **Другие значения**：нет

!> В основе используется PHP счетчик ссылок для хранения переменных, буфер занимает только `$capacity * sizeof(zval)` bytes памяти, в версии PHP7 `zval` составляет `16` bytes, например, когда `$capacity = 1024`, `Channel` в最高气温 случае займет `16K` памяти

!> При использовании в `Server` необходимо создать после [onWorkerStart](/server/events?id=onworkerstart)


### push()

Записать данные в канал.

```php
Swoole\Coroutine\Channel->push(mixed $data, float $timeout = -1): bool
```

  * **Параметры** 

    * **`mixed $data`**
      * **Функция**：записать данные 【можно использовать любые виды PHP переменных, включая анонимные функции и ресурсы】
      * **По умолчанию**：нет
      * **Другие значения**：нет

      !> Чтобы избежать歧义和 ошибок, не следует записывать в канал `null` и `false`

    * **`float $timeout`**
      * **Функция**：Установить время ожидания
      * **Единица измерения**：секунда 【поддерживается плавающая точка, например, `1.5` означает `1s`+`500ms`】
      * **По умолчанию**：`-1`
      * **Другие значения**：нет
      * **Влияние версии**：Swoole version >= v4.2.12

      !> Если канал полон, `push` будет замораживать текущую корутину, и в течение установленного времени, если никто не потребует данные, произойдет просрочка, и底层 восстановит текущую корутину, `push` немедленно вернет `false`, запись потерпела неудачу

  * **Возвращаемое значение**

    * Успешное выполнение возвращает `true`
    * Когда канал закрыт, неудачное выполнение возвращает `false`, можно использовать `$channel->errCode` чтобы получить код ошибки

  * **Расширение**

    * **Канал полон**

      * Автоматически `yield` текущую корутину, после того как другие потребители корутин `pop` потребуют данные, канал будет доступен для записи, и текущая корутина будет возобновлена
      * Когда несколько производителей корутин одновременно `push`,底层 автоматически выстраивает очередь, и底层 будет по очереди возобновлять эти производители корутин

    * **Канал пуст**

      * Автоматически разбудить одного потребителя корутин
      * Когда несколько потребителей корутин одновременно `pop`,底层 автоматически выстраивает очередь, и по очереди возобновляются эти потребители корутин

!> `Coroutine\Channel` использует локальную память, память между разными процессами изолирована. Можно выполнять только `push` и `pop` операции внутри одной и той же процесса в разных корутинах 


### pop()

Чтение данных из канала.

```php
Swoole\Coroutine\Channel->pop(float $timeout = -1): mixed
```

  * **Параметры** 

    * **`float $timeout`**
      * **Функция**：Установить время ожидания
      * **Единица измерения**：секунда 【поддерживается плавающая точка, например, `1.5` означает `1s`+`500ms`】
      * **По умолчанию**：`-1` 【означает никогда не просрочивать】
      * **Другие значения**：нет
      * **Влияние версии**：Swoole version >= v4.0.3

  * **Возвращаемое значение**

    * Возвращаемое значение может быть любым видом PHP переменных, включая анонимные функции и ресурсы
    * Когда канал закрыт, неудачное выполнение возвращает `false`

  * **Расширение**

    * **Канал полон**

      * После `pop`, потребление данных автоматически разбудит одного производителя корутина, чтобы он записал новые данные
      * Когда несколько производителей корутин одновременно `push`,底层 автоматически выстраивает очередь, и по очереди возобновляются эти производители корутин

    * **Канал пуст**

      * Автоматически `yield` текущую корутину, после того как другие производители корутин `push` произведут данные, канал будет доступен для чтения, и текущая корутина будет возобновлена
      * Когда несколько потребителей корутин одновременно `pop`,底层 автоматически выстраивает очередь, и по очереди возобновляются эти потребители корутин


### stats()

Получить статистику канала.

```php
Swoole\Coroutine\Channel->stats(): array
```

  * **Возвращаемое значение**

    Возвращается массив, буфер канала будет включать `4` элемента информации, канал без буфера возвращает `2` элемента информации
    
    - `consumer_num` Количество потребителей, указывает на то, что текущий канал пуст, есть `N` корутин, ожидающих, что другие корутины вызовут метод `push` для производства данных
    - `producer_num` Количество производителей, указывает на то, что текущий канал полон, есть `N` корутин, ожидающих, что другие корутины вызовут метод `pop` для потребления данных
    - `queue_num` Количество элементов в канале

```php
array(
  "consumer_num" => 0,
  "producer_num" => 1,
  "queue_num" => 10
);
```


### close()

Завершить канал. И разбудить все корутины, ожидающие чтения и письма.

```php
Swoole\Coroutine\Channel->close(): bool
```

!> Разбудить всех производителей корутин, метод `push` вернет `false`; разбудить всех потребителей корутин, метод `pop` вернет `false`


### length()

Получить количество элементов в канале.

```php
Swoole\Coroutine\Channel->length(): int
```


### isEmpty()

Проверить, является ли текущий канал пустым.

```php
Swoole\Coroutine\Channel->isEmpty(): bool
```


### isFull()

Проверить, полон ли текущий канал.

```php
Swoole\Coroutine\Channel->isFull(): bool
```


## Свойства


### capacity

Емкость канала буфера.

Вопросы, установленные в [конструкторе](/coroutine/channel?id=__construct), будут сохраняться здесь, но **если установленный объем меньше 1**, то эта переменная будет равна 1

```php
Swoole\Coroutine\Channel->capacity: int
```
### errCode

Получить код ошибки.

```php
Swoole\Coroutine\Channel->errCode: int
```

  * **Возвращаемое значение**


Значение | Соответствующая константа | Смысл
---|---|---

0 | SWOOLE_CHANNEL_OK | По умолчанию успешный
-1 | SWOOLE_CHANNEL_TIMEOUT | Отказ pop при таймауте (таймаут)
-2 | SWOOLE_CHANNEL_CLOSED | Канал уже закрыт, продолжать работу с каналом
