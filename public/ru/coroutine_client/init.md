# Корутинный клиент <!-- {docsify-ignore-all} -->

Ниже представлены встроенные классы корутинных клиентов Swoole, среди которых те, что отмечены ⚠️, не рекомендуется использовать дальше, вместо этого можно использовать的原生 PHP-функции + [Корутинизация с одним нажатием](/runtime).

* [Клиенты TCP/UDP/UnixSocket](coroutine_client/client.md)
* [Клиенты сокетов](coroutine_client/socket.md)
* [Клиенты HTTP/WebSocket](coroutine_client/http_client.md)
* [Клиенты HTTP2](coroutine_client/http2_client.md)
* [Клиенты PostgreSQL](coroutine_client/postgresql.md)
* [Клиенты FastCGI](coroutine_client/fastcgi.md)
⚠️ [Клиенты Redis](coroutine_client/redis.md)
⚠️ [Клиенты MySQL](coroutine_client/mysql.md)
* [Система](/coroutine/system) API системы


## Правила таймаута

Все сетевые запросы (создание соединения, отправка данных, прием данных) могут быть timed out, и в `Swoole` корутинных клиентах таймаут устанавливаются тремя способами:

1. Передача времени таймаута через параметры метода, например, [Co\Client->connect()](/coroutine_client/client?id=connect), [Co\Http\Client->recv()](/coroutine_client/http_client?id=recv), [Co\MySQL->query()](/coroutine_client/mysql?id=query) и т.д.

!> Этот способ имеет наименьшую область влияния (влияет только на текущее вызов函数), имеет наивысшую приоритетность (данный вызов function игнорирует следующие `2`, `3` настройки).

2. Установка таймаута через методы `set()` или `setOption()` класса `Swoole` корутинного клиента, например:

```php
$client = new Co\Client(SWOOLE_SOCK_TCP);
//или
$client = new Co\Http\Client("127.0.0.1", 80);
//или
$client = new Co\Http2\Client("127.0.0.1", 443, true);
$client->set(array(
    'timeout' => 0.5,//общий таймаут, включая соединение, отправку, прием всех таймаутов
    'connect_timeout' => 1.0,//таймаут соединения, заменяет первый общий timeout
    'write_timeout' => 10.0,//таймаут отправки, заменяет первый общий timeout
    'read_timeout' => 0.5,//таймаут приема, заменяет первый общий timeout
));

//Co\Redis() не имеет настроек write_timeout и read_timeout
$client = new Co\Redis();
$client->setOption(array(
    'timeout' => 1.0,//общий таймаут, включая соединение, отправку, прием всех таймаутов
    'connect_timeout' => 0.5,//таймаут соединения, заменяет первый общий timeout 
));

//Co\MySQL() не имеет функции настройки
$client = new Co\MySQL();

//Co\Socket настраивается через setOption
$socket = new Co\Socket(AF_INET, SOCK_STREAM, SOL_TCP);
$timeout = array('sec'=>1, 'usec'=>500000);
$socket->setOption(SOL_SOCKET, SO_RCVTIMEO, $timeout);//время таймаута приема данных
$socket->setOption(SOL_SOCKET, SO_SNDTIMEO, $timeout);//конфигурация таймаута соединения и отправки данных
```

!> Этот способ влияет только на текущий класс, будет перекрыт первым способом, игнорирует следующую третью настройку.

3. Как видно из вышеуказанных способов настройки таймаута `2`, правила очень сложны и не едины, чтобы избежать необходимости осторожно устанавливать их везде, начиная с версии `v4.2.10`, все корутинные клиенты предлагают глобальные единые правила настройки таймаута, это имеет наибольший эффект, наименьшую приоритетность, как следует:

```php
Co::set([
    'socket_timeout' => 5,
    'socket_connect_timeout' => 1,
    'socket_read_timeout' => 1,
    'socket_write_timeout' => 1,
]);
```

+ `-1`: означает никогда не превышать таймаут
+ `0`: означает не изменять время таймаута
+ `Другие значения больше 0`: означают установка таймера с определенным количеством секунд, максимальная точность составляет `1 миллисекунда`, это плавающая точка, `0.5` означает `500 миллисекунд`
+ `socket_connect_timeout`: означает время таймаута создания TCP-соединения, по умолчанию `1 секунда`, начиная с версии `v4.5.x` по умолчанию `2 секунды`
+ `socket_timeout`: означает время таймаута чтения/записи TCP, по умолчанию `-1`, начиная с версии `v4.5.x` по умолчанию `60 секунд`
Если вы хотите разделить чтение и запись, смотрите следующую конфигурацию
+ `socket_read_timeout`: добавлен в версии `v4.3`, означает время таймаута **чтения** TCP, по умолчанию `-1`, начиная с версии `v4.5.x` по умолчанию `60 секунд`
+ `socket_write_timeout`: добавлен в версии `v4.3`, означает время таймаута **записи** TCP, по умолчанию `-1`, начиная с версии `v4.5.x` по умолчанию `60 секунд`

!> **то есть:** до версии `v4.5.x` все корутинные клиенты Swoole, которые не использовали первые два способа настройки таймаута, по умолчанию имеют таймаут соединения `1 секунды`, а чтение/запись никогда не превышают таймаут;  
Начиная с версии `v4.5.x` по умолчанию таймаут соединения составляет `60 секунд`, а чтение/запись - `60 секунд`;  
Если в процессе изменить глобальный таймаут, это не повлияет на уже созданные сокеты.

### Таймауты официального сетевого библиотеки PHP

Помимо вышеупомянутых корутинных клиентов Swoole, которые используются в [Корутинизации с одним нажатием](/runtime), там используются методы, предоставляемые原生 PHP, их время таймаута зависит от настройки [default_socket_timeout](http://php.net/manual/zh/filesystem.configuration.php), разработчики могут установить его отдельно с помощью `ini_set('default_socket_timeout', 60)`, его默认ное значение составляет 60.
