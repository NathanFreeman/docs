# Настройка ядерных параметров


## Установка ulimit

`ulimit -n` следует настроить на 100000 или даже больше. Для изменения в командной строке используйте команду `ulimit -n 100000`. Если изменения не применяются, необходимо отредактировать файл `/etc/security/limits.conf` и добавить следующее:

```
* soft nofile 262140
* hard nofile 262140
root soft nofile 262140
root hard nofile 262140
* soft core unlimited
* hard core unlimited
root soft core unlimited
root hard core unlimited
```

Обратите внимание, что после изменения файла `limits.conf` система требует перезагрузки для применения изменений.


## Настройка ядра

В операционной системе `Linux` существует три способа изменения ядерных параметров:



- Изменение файла `/etc/sysctl.conf`, добавление конфигурационных опций в формате `ключ = значение`, после изменения сохранения вызвать `sysctl -p` для загрузки новой конфигурации

- Использование команды `sysctl` для временного изменения, например: `sysctl -w net.ipv4.tcp_mem="379008 505344 758016"`
- Прямое изменение файлов в каталоге `/proc/sys/`, например: `echo "379008 505344 758016" > /proc/sys/net/ipv4/tcp_mem`

> Первый способ вступает в силу после перезагрузки операционной системы, второй и третий методы теряют силу после перезагрузки.


### net.unix.max_dgram_qlen = 100

Swoole использует unix socket dgram для межпроцессного общения, и если объем запросов велик, необходимо настроить этот параметр. По умолчанию система设置为 10, его можно увеличить до 100 или больше. Или увеличить количество рабочих процессов, чтобы уменьшить объем запросов, распределяемый каждым рабочим процессом.


### net.core.wmem_max

Изменение этого параметра увеличивает размер буфера сокетов.

```
net.ipv4.tcp_mem  =   379008       505344  758016
net.ipv4.tcp_wmem = 4096        16384   4194304
net.ipv4.tcp_rmem = 4096          87380   4194304
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
```


### net.ipv4.tcp_tw_reuse

Включение или отключение reuse сокетов, эта функция позволяет серверу быстро повторно использовать слушаемый порт после перезагрузки. Если этот параметр не установлен, это может привести к неудаче запуска сервера из-за несвоевременного освобождения порта после его закрытия.


### net.ipv4.tcp_tw_recycle

Использование быстрого восстановления сокетов, для серверов с короткими соединениями необходимо включить этот параметр. Этот параметр указывает на включение быстрого восстановления TIME-WAIT сокетов в TCP-соединениях, по умолчанию в Linux он установлен на 0, что означает отключение. Включение этого параметра может привести к нестабильности подключений пользователей с NAT, пожалуйста, тщательно тестируйте перед включением.


## Настройка очереди сообщений

Когда используется очередь сообщений в качестве способа межпроцессного общения, необходимо настроить следующие ядерные параметры:



- kernel.msgmnb = 4203520, максимальный размер очереди сообщений в байтах

- kernel.msgmni = 64, максимальное количество不允许 созданных очереди сообщений
- kernel.msgmax = 8192, максимальная длина одного сообщения в очереди сообщений


## FreeBSD/MacOS



- sysctl -w net.local.dgram.maxdgram=8192
- sysctl -w net.local.dgram.recvspace=200000
  Изменение размера буфера Unix Socket


## Включение CoreDump

Установка ядерных параметров

```
kernel.core_pattern = /data/core_files/core-%e-%p-%t
```

Используйте команду `ulimit -c` для просмотра текущего ограничения на coredump файл

```shell
ulimit -c
```

Если ограничение равно 0, необходимо изменить `/etc/security/limits.conf` и установить limit.

> После включения core-dump, в случае возникновения исключения в программе, процесс будет экспортирован в файл. Это очень помогает в расследовании проблем с программами.


## Другие важные настройки



- net.ipv4.tcp_syncookies=1

- net.ipv4.tcp_max_syn_backlog=81920

- net.ipv4.tcp_synack_retries=3

- net.ipv4.tcp_syn_retries=3

- net.ipv4.tcp_fin_timeout = 30

- net.ipv4.tcp_keepalive_time = 300

- net.ipv4.tcp_tw_reuse = 1

- net.ipv4.tcp_tw_recycle = 1

- net.ipv4.ip_local_port_range = 20000 65000

- net.ipv4.tcp_max_tw_buckets = 200000
- net.ipv4.route.max_size = 5242880

## Проверка生效configuration

Например, после изменения `net.unix.max_dgram_qlen = 100`, используйте

```shell
cat /proc/sys/net/unix/max_dgram_qlen
```

Если изменение успешно, вот новое значение, которое было установлено.
